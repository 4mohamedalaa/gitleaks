name: GitLeaks Secret Scanner

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight
  workflow_dispatch:      # Allow manual triggers

jobs:
  scan:
    name: GitLeaks Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          wget https://github.com/zricethezav/gitleaks/releases/download/v8.16.1/gitleaks_8.16.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.16.1_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        id: gitleaks
        continue-on-error: true
        run: |
          # Run gitleaks and capture both output and exit code
          OUTPUT=$(gitleaks detect --no-git --source . -c .gitleaks.toml -f json)
          EXIT_CODE=$?
          
          # Save the output to a file
          echo "$OUTPUT" > leaks.json
          
          # Generate SARIF report
          gitleaks detect --no-git --source . -c .gitleaks.toml -f sarif > results.sarif || true
          
          # Set environment variable based on exit code
          if [ $EXIT_CODE -eq 1 ]; then
            echo "LEAKS_FOUND=true" >> $GITHUB_ENV
            echo "Secrets detected in the repository!"
            cat leaks.json
          else
            echo "No leaks found"
            echo "LEAKS_FOUND=false" >> $GITHUB_ENV
            echo "[]" > leaks.json
          fi

      - name: Create Issue for Detected Secrets
        if: env.LEAKS_FOUND == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let leaksDetail = '[]';
            
            try {
              const fileContent = fs.readFileSync('leaks.json', 'utf8');
              if (fileContent.trim()) {
                const leaks = JSON.parse(fileContent);
                leaksDetail = JSON.stringify(leaks, null, 2);
              }
            } catch (error) {
              console.log('Error reading or parsing leaks.json:', error);
            }

            const issueBody = `## ðŸš¨ Security Issue: Potential secrets detected
            
            Gitleaks has detected secrets in the codebase.
            
            **Details:**
            - Commit: ${context.sha}
            - Branch: ${context.ref}
            - Workflow run: ${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            
            ### Detected Secrets:
            \`\`\`json
            ${leaksDetail}
            \`\`\`
            
            ### Required Actions:
            1. Remove ALL detected secrets from the codebase
            2. Rotate any exposed credentials
            3. Update affected systems
            
            â›” **PIPELINE BLOCKED**: This pipeline will continue to fail until all secrets are removed.
            
            Please handle this with urgency.`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Security Issue: Secrets Found in Repository',
              body: issueBody,
              labels: ['security', 'gitleaks', 'pipeline-blocker']
            });

      - name: Save Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-scan-results
          path: |
            leaks.json
            results.sarif
          retention-days: 30

      - name: Fail if leaks found
        if: env.LEAKS_FOUND == 'true'
        run: |
          echo "Secrets were detected in the repository. Please check the created issue for details."
          exit 1